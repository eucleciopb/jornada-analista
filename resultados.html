<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Resultados dos Treinamentos</title>
  <link rel="stylesheet" href="css/styles.css" />
</head>

<body class="bg">
<header class="topbar">
  <div>
    <h2>Resultados dos Treinamentos</h2>
    <div id="userInfo" class="hint" style="color:#d1d5db;margin-top:4px;"></div>
  </div>

  <div class="top-actions">
    <button id="btnMenu" class="btn-secondary" type="button">Voltar ao Menu</button>
    <button id="btnLogout" class="btn-secondary" type="button">Sair</button>
  </div>
</header>

<main class="card wide">

  <section class="row-between" style="align-items:flex-end;">
    <div>
      <h3>Painel de Validação do Desafio</h3>
      <p class="hint">
        Aqui você valida se o desafio foi executado e se houve melhora do indicador.
        A apuração “Feito/Não feito” pode vir de outro lugar — esta tela só registra e exibe.
      </p>
    </div>

    <div style="min-width:260px;">
      <label for="monthPicker">Mês</label>
      <input id="monthPicker" type="month" />
    </div>
  </section>

  <p id="msg" class="msg"></p>

  <!-- Resumo -->
  <section class="result-cards" style="margin-top:10px;">
    <div class="result-card">
      <div class="rc-title">Total de desafios</div>
      <div id="kpiTotal" class="rc-value">0</div>
    </div>
    <div class="result-card">
      <div class="rc-title">Feitos (apuração)</div>
      <div id="kpiFeitos" class="rc-value">0</div>
    </div>
    <div class="result-card">
      <div class="rc-title">Melhorou</div>
      <div id="kpiMelhorou" class="rc-value">0</div>
    </div>
    <div class="result-card">
      <div class="rc-title">Não melhorou</div>
      <div id="kpiNao" class="rc-value">0</div>
    </div>
    <div class="result-card">
      <div class="rc-title">Pendente</div>
      <div id="kpiPend" class="rc-value">0</div>
    </div>
  </section>

  <hr class="sep" />

  <!-- filtros -->
  <section class="row-between" style="align-items:flex-end;">
    <div style="flex:1; min-width:260px;">
      <label for="busca">Buscar</label>
      <input id="busca" type="text" placeholder="Treinamento, CD, desafio, meta..." />
    </div>

    <div style="min-width:220px;">
      <label for="fPublico">Público</label>
      <select id="fPublico">
        <option value="">Todos</option>
        <option value="Gestor">Gestor</option>
        <option value="Vendedor">Vendedor</option>
      </select>
    </div>

    <div style="min-width:220px;">
      <label for="fStatus">Status</label>
      <select id="fStatus">
        <option value="">Todos</option>
        <option value="pendente">Pendente</option>
        <option value="feito">Feito</option>
        <option value="naoFeito">Não feito</option>
        <option value="melhorou">Melhorou</option>
        <option value="naoMelhorou">Não melhorou</option>
      </select>
    </div>
  </section>

  <div class="table-wrap" style="margin-top:12px;">
    <table class="table table-sticky">
      <thead>
        <tr>
          <th style="width:110px;">Data</th>
          <th style="width:120px;">Público</th>
          <th style="width:240px;">Treinamento</th>
          <th style="width:220px;">CD</th>
          <th style="width:280px;">Desafio</th>
          <th style="width:280px;">Meta</th>
          <th style="width:120px;">Feito?</th>
          <th style="width:150px;">Melhora?</th>
          <th style="width:110px;">Antes</th>
          <th style="width:110px;">Depois</th>
          <th style="width:160px;">Obs Validação</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

  <div class="page-actions" style="margin-top:12px; justify-content:flex-end; gap:10px;">
    <button id="btnSalvar" type="button">Salvar Validações</button>
  </div>

</main>

<script>
/* =========================
   Sessão
========================= */
const usuario = (localStorage.getItem("usuarioLogado") || "").trim();
if (!usuario) window.location.href = "index.html";
document.getElementById("userInfo").textContent = `Usuário: ${usuario}`;

document.getElementById("btnMenu").onclick = () => window.location.href = "menu.html";
document.getElementById("btnLogout").onclick = () => {
  localStorage.removeItem("usuarioLogado");
  window.location.href = "index.html";
};

/* =========================
   Storage keys
   - treinamentos_realizados_<usuario> (criado na tela treinamentos.html)
   - validacoes_resultados_<usuario>   (criado aqui)
========================= */
function keyTreinos(){ return `treinamentos_realizados_${usuario}`; }
function keyValid(){ return `validacoes_resultados_${usuario}`; }

/* =========================
   UI
========================= */
const monthPicker = document.getElementById("monthPicker");
const busca = document.getElementById("busca");
const fPublico = document.getElementById("fPublico");
const fStatus = document.getElementById("fStatus");
const tbody = document.getElementById("tbody");
const btnSalvar = document.getElementById("btnSalvar");
const msg = document.getElementById("msg");

const kpiTotal = document.getElementById("kpiTotal");
const kpiFeitos = document.getElementById("kpiFeitos");
const kpiMelhorou = document.getElementById("kpiMelhorou");
const kpiNao = document.getElementById("kpiNao");
const kpiPend = document.getElementById("kpiPend");

/* =========================
   Helpers
========================= */
function setMsg(text, type="info"){
  msg.textContent = text || "";
  msg.style.color = type === "success" ? "#22c55e" : (type === "error" ? "#ef4444" : "#d1d5db");
}
function pad2(n){ return String(n).padStart(2,"0"); }
function toMonthKey(d){ return `${d.getFullYear()}-${pad2(d.getMonth()+1)}`; }
function toBR(iso){
  if (!iso) return "-";
  const [y,m,d] = iso.split("-");
  return `${d}/${m}/${y}`;
}
function normalize(s){ return (s || "").replace(/\s+/g," ").trim(); }
function isValidNumber(x){ return Number.isFinite(x) && !Number.isNaN(x); }

/* =========================
   Load/Save
========================= */
function loadTreinos(){
  const raw = localStorage.getItem(keyTreinos());
  if (!raw) return [];
  try {
    const arr = JSON.parse(raw);
    return Array.isArray(arr) ? arr : [];
  } catch { return []; }
}

// validações por ID do registro do treinamento
// shape: { [treinoId]: { feito: "pendente"|"sim"|"nao", melhora: "pendente"|"sim"|"nao", antes: number|null, depois: number|null, obs: string } }
function loadValid(){
  const raw = localStorage.getItem(keyValid());
  if (!raw) return {};
  try {
    const obj = JSON.parse(raw);
    return obj && typeof obj === "object" ? obj : {};
  } catch { return {}; }
}
function saveValid(obj){
  localStorage.setItem(keyValid(), JSON.stringify(obj));
}

/* =========================
   Render
========================= */
function render(){
  const monthKey = monthPicker.value;
  const q = (busca.value || "").toLowerCase();
  const pub = fPublico.value;
  const status = fStatus.value;

  const treinos = loadTreinos()
    .filter(t => t && t.data && t.id)
    .filter(t => (t.data || "").slice(0,7) === monthKey) // yyyy-mm
    .filter(t => !pub || t.publico === pub);

  const valid = loadValid();

  // filtros e tabela
  let rows = treinos.map(t => {
    const v = valid[t.id] || { feito:"pendente", melhora:"pendente", antes:null, depois:null, obs:"" };
    return { t, v };
  });

  if (q){
    rows = rows.filter(({t}) => {
      const blob = [t.treinamento, t.cd, t.desafio, t.meta, t.obs].join(" ").toLowerCase();
      return blob.includes(q);
    });
  }

  if (status){
    rows = rows.filter(({v}) => {
      if (status === "pendente") return v.feito === "pendente" || v.melhora === "pendente";
      if (status === "feito") return v.feito === "sim";
      if (status === "naoFeito") return v.feito === "nao";
      if (status === "melhorou") return v.melhora === "sim";
      if (status === "naoMelhorou") return v.melhora === "nao";
      return true;
    });
  }

  // KPIs (sempre do mês, sem os filtros de busca/status pra não confundir)
  const all = treinos.map(t => valid[t.id] || { feito:"pendente", melhora:"pendente" });
  const total = all.length;
  const feitos = all.filter(v => v.feito === "sim").length;
  const melhorou = all.filter(v => v.melhora === "sim").length;
  const nao = all.filter(v => v.melhora === "nao").length;
  const pend = all.filter(v => v.melhora === "pendente").length;

  kpiTotal.textContent = total;
  kpiFeitos.textContent = feitos;
  kpiMelhorou.textContent = melhorou;
  kpiNao.textContent = nao;
  kpiPend.textContent = pend;

  tbody.innerHTML = "";

  if (rows.length === 0){
    tbody.innerHTML = `<tr><td colspan="11" style="opacity:.8;">Sem registros para esse mês/filtro.</td></tr>`;
    return;
  }

  for (const {t, v} of rows){
    const tr = document.createElement("tr");
    tr.dataset.id = t.id;

    tr.innerHTML = `
      <td>${toBR(t.data)}</td>
      <td><span class="pill">${t.publico || "-"}</span></td>
      <td>${t.treinamento || "-"}</td>
      <td>${t.cd || "-"}</td>
      <td>${t.desafio || "-"}</td>
      <td>${t.meta || "-"}</td>

      <td>
        <select data-feito>
          <option value="pendente" ${v.feito==="pendente"?"selected":""}>Pendente</option>
          <option value="sim" ${v.feito==="sim"?"selected":""}>Sim</option>
          <option value="nao" ${v.feito==="nao"?"selected":""}>Não</option>
        </select>
      </td>

      <td>
        <select data-melhora>
          <option value="pendente" ${v.melhora==="pendente"?"selected":""}>Pendente</option>
          <option value="sim" ${v.melhora==="sim"?"selected":""}>Sim</option>
          <option value="nao" ${v.melhora==="nao"?"selected":""}>Não</option>
        </select>
      </td>

      <td><input data-antes type="number" step="0.01" placeholder="-" value="${v.antes ?? ""}"></td>
      <td><input data-depois type="number" step="0.01" placeholder="-" value="${v.depois ?? ""}"></td>
      <td><input data-obs type="text" maxlength="120" placeholder="Obs..." value="${v.obs || ""}"></td>
    `;

    // destaque visual por status
    if (v.melhora === "sim") tr.classList.add("row-good");
    if (v.melhora === "nao") tr.classList.add("row-bad");

    tbody.appendChild(tr);
  }
}

/* =========================
   Save
========================= */
btnSalvar.onclick = () => {
  const valid = loadValid();
  const trs = [...tbody.querySelectorAll("tr[data-id]")];

  for (const tr of trs){
    const id = tr.dataset.id;

    const feito = tr.querySelector("[data-feito]")?.value || "pendente";
    const melhora = tr.querySelector("[data-melhora]")?.value || "pendente";

    const antesRaw = tr.querySelector("[data-antes]")?.value;
    const depoisRaw = tr.querySelector("[data-depois]")?.value;

    const antes = (antesRaw === "" ? null : Number(antesRaw));
    const depois = (depoisRaw === "" ? null : Number(depoisRaw));

    const obs = normalize(tr.querySelector("[data-obs]")?.value || "");

    // validação leve
    if (antes !== null && !isValidNumber(antes)) { setMsg("Campo 'Antes' inválido.", "error"); return; }
    if (depois !== null && !isValidNumber(depois)) { setMsg("Campo 'Depois' inválido.", "error"); return; }

    valid[id] = { feito, melhora, antes, depois, obs };
  }

  saveValid(valid);
  setMsg("Validações salvas ✅", "success");
  render();
};

/* =========================
   Init / listeners
========================= */
monthPicker.value = toMonthKey(new Date());
render();

monthPicker.addEventListener("change", render);
busca.addEventListener("input", render);
fPublico.addEventListener("change", render);
fStatus.addEventListener("change", render);
</script>

<style>
/* pequeno upgrade visual específico */
.result-cards{
  display:grid;
  grid-template-columns: repeat(5, minmax(140px, 1fr));
  gap: 12px;
}
@media (max-width: 900px){
  .result-cards{ grid-template-columns: 1fr 1fr; }
}
.result-card{
  border: 1px solid rgba(255,255,255,.10);
  background: rgba(255,255,255,.03);
  border-radius: 18px;
  padding: 12px 12px;
}
.rc-title{
  font-size: 12px;
  color: rgba(209,213,219,.85);
  margin-bottom: 6px;
  font-weight: 650;
}
.rc-value{
  font-size: 22px;
  font-weight: 900;
  letter-spacing: .2px;
}
.pill{
  display:inline-flex;
  padding: 6px 10px;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.04);
  font-weight: 800;
  font-size: 12px;
}
tbody select, tbody input{
  width: 100%;
  padding: 10px 10px;
  border-radius: 14px;
  border: 1px solid rgba(255,255,255,.10);
  background: rgba(255,255,255,.04);
  color: rgba(255,255,255,.95);
  outline: none;
}
tbody select:focus, tbody input:focus{
  border-color: rgba(255,59,59,.55);
  box-shadow: 0 0 0 4px rgba(217,27,46,.18);
}
.row-good{ background: rgba(34,197,94,.10) !important; }
.row-bad{ background: rgba(239,68,68,.10) !important; }
</style>

</body>
</html>
